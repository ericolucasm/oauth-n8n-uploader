<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XSolve - Upload com OAuth</title>

  <!-- CSS -->
  <link rel="stylesheet" href="css/styles.css" />

  <!-- SDKs -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://js.live.net/v7.2/OneDrive.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- OAuth + Picker -->
  <script src="js/oauth.js" defer></script>
</head>

<body>
  <div class="container">
    <img src="images/xsolve-logo.png" alt="XSolve Consultoria" class="logo" />
    <h1>Envie seus arquivos com segurança</h1>

    <!-- Status do fluxo com API -->
    <p id="api-flow-status" style="text-align:center; margin-top:10px; display:none;"></p>

    <!-- HOME -->
    <div id="home-options">

      <!-- Seção 1: Fluxo Sem API Integrada (atual) -->
      <div class="flow-section">
        <h2 class="flow-title">Fluxo Sem API Integrada</h2>
        <button class="login-button" onclick="escolherDispositivo()">Selecionar do Dispositivo</button>
        <button class="login-button" onclick="escolherNuvem()">Selecionar da Nuvem</button>
      </div>

      <!-- Seção 2: Fluxo Com API Integrada (novo) -->
      <div class="flow-section" style="margin-top: 18px;">
        <h2 class="flow-title">Fluxo Com API Integrada</h2>
        <button class="login-button" id="btn-start-api-flow">Iniciar Processamento (API)</button>
      </div>

    </div>

    <!-- VOLTAR -->
    <div id="voltar-home" style="display: none; margin-top: 20px;">
      <button class="login-button" onclick="voltarParaHome()">← Voltar à Home</button>
    </div>

    <!-- LOGIN GOOGLE -->
    <div id="auth-buttons" style="display: none;">
      <button class="login-button" onclick="loginWithGoogle()">
        <img src="images/google-logo.png" alt="Google" class="login-icon" />
        Login com Google
      </button>
    </div>

    <!-- UPLOAD LOCAL -->
    <div id="upload-local" style="display: none;">
      <label for="file" class="custom-file-upload">Escolher arquivo do dispositivo</label>
      <input type="file" id="file" name="data" />
    </div>

    <!-- UPLOAD NUVEM -->
    <div id="upload-nuvem" style="display: none;">
      <button class="custom-file-upload" id="cloud-picker-btn">Selecionar arquivo da nuvem</button>
    </div>

    <!-- Nome do arquivo -->
    <p id="file-name"></p>

    <!-- Enviar -->
    <div id="upload-actions" style="display: none;">
      <button class="login-button" id="upload-btn">Enviar Arquivo</button>
    </div>

    <!-- Link de Resultados -->
    <div style="text-align: center; margin-top: 40px;">
      <a href="https://docs.google.com/spreadsheets/d/1ZwYH7n6vN0I7ueDp5Omz21Zxczj3PwvZpemIeGq64UA/edit?usp=sharing"
         target="_blank"
         style="font-size: 16px; color: #007bff; text-decoration: none;">
         <strong> Link para Arquivo com Resultados</strong>
      </a>
    </div>
  </div>

  <!-- Script do novo botão (Fluxo Com API Integrada) -->
  <script>
    // ✅ COLE A URL DO WEBHOOK DO "Fluxo Com API Integrada" AQUI:
    // Ex: https://seu-n8n.app.n8n.cloud/webhook/abc123
    const N8N_WEBHOOK_API_INTEGRADA = "COLE_AQUI_A_URL_DO_WEBHOOK";

    const btnStart = document.getElementById("btn-start-api-flow");
    const statusEl = document.getElementById("api-flow-status");

    function setStatus(msg, isError = false) {
      if (!statusEl) return;
      statusEl.style.display = "block";
      statusEl.style.color = isError ? "#b00020" : "#1f5e2a";
      statusEl.style.fontWeight = "600";
      statusEl.textContent = msg;
    }

    async function startApiIntegratedFlow() {
      if (!N8N_WEBHOOK_API_INTEGRADA || N8N_WEBHOOK_API_INTEGRADA.includes("https://ericopessoal.app.n8n.cloud/webhook/xsolve-start-api")) {
        setStatus("⚠️ Falta configurar a URL do webhook do fluxo com API integrada.", true);
        return;
      }

      btnStart.disabled = true;
      setStatus("⏳ Iniciando processamento...");

      try {
        const resp = await fetch(N8N_WEBHOOK_API_INTEGRADA, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          // Payload opcional: ajuda no debug do n8n
          body: JSON.stringify({ source: "vercel-ui", action: "start" })
        });

        if (!resp.ok) {
          const txt = await resp.text().catch(() => "");
          throw new Error(`HTTP ${resp.status} ${resp.statusText}${txt ? " - " + txt : ""}`);
        }

        setStatus("✅ Fluxo iniciado com sucesso. Você pode acompanhar a execução no n8n.");
      } catch (err) {
        setStatus(`❌ Erro ao iniciar o fluxo: ${err.message}`, true);
      } finally {
        btnStart.disabled = false;
      }
    }

    if (btnStart) btnStart.addEventListener("click", startApiIntegratedFlow);
  </script>
</body>
</html>
